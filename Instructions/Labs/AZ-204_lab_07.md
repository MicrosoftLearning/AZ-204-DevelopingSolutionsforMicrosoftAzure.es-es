---
lab:
  az204Title: 'Lab 07: Access resource secrets more securely across services'
  az204Module: 'Learning Path 07: Implement secure Azure solutions'
---

# Laboratorio 07: Acceso a secretos de recursos de forma más segura entre servicios

## Interfaz de usuario de Microsoft Azure

Dada la naturaleza dinámica de las herramientas en la nube de Microsoft, puede experimentar cambios en la interfaz de usuario de Azure que se producen después del desarrollo de este contenido de entrenamiento. Como resultado, es posible que las instrucciones y los pasos del laboratorio no se alineen correctamente.

Microsoft actualiza este curso de entrenamiento cuando la comunidad aporta los cambios necesarios a nuestra atención. Sin embargo, dado que las actualizaciones en la nube se producen con frecuencia, es posible que se produzcan cambios en la interfaz de usuario antes de que se actualice este contenido de entrenamiento. **Si esto ocurre, adáptese a los cambios y, a continuación, trabaje con ellos en los laboratorios según sea necesario.**

## Instructions

### Antes de comenzar

#### Inicio de sesión al entorno de laboratorio

Inicie sesión en la máquina virtual (VM) de Windows 10 con las credenciales siguientes:

- Nombre de usuario: `Admin`
- Contraseña: `Pa55w.rd`

> **Nota**: El instructor le proporcionará instrucciones para conectarse al entorno de laboratorio virtual.

#### Revisión de las aplicaciones instaladas

Busque la barra de tareas en el escritorio de Windows 10. La barra de tareas contiene los iconos de las aplicaciones que usará en este laboratorio, entre los que se incluyen:

- Microsoft Edge
- Explorador de archivos
- Terminal Windows
- Visual Studio Code

## Escenario de laboratorio

En este laboratorio, creará una cuenta de almacenamiento y una aplicación de función de Azure que accederá a la cuenta de almacenamiento. Para demostrar el almacenamiento seguro de la información de la cadena de conexión, aprovisionará un recurso de Key Vault y administrará los secretos adecuados para almacenar la información de la cadena de conexión. También administrará la identidad de servicio para obtener acceso seguro a la información de la cadena de conexión de la cuenta de almacenamiento.

## Diagrama de la arquitectura

![Diagrama de arquitectura que muestra un usuario que accede a los secretos de recursos de forma más segura entre servicios.](./media/Lab07-Diagram.png)

### Ejercicio 1: Creación de recursos de Azure

#### Tarea 1: Abra Azure Portal

1. En la barra de tareas, seleccione el icono de **Microsoft Edge**.

1. En la ventana del explorador abierto, vaya a Azure Portal en `https://portal.azure.com` y, a continuación, inicie sesión con la cuenta que va a usar para este laboratorio.

    > **Nota**: Si es la primera vez que inicia sesión en Azure Portal, se le ofrecerá un paseo por el portal. Seleccione **Introducción** para omitir el paseo y empezar a usar el portal.

#### Tarea 2: Creación de una cuenta de almacenamiento

1. En Azure Portal, use el cuadro de texto **Buscar recursos, servicios y documentos** para buscar **Cuentas de almacenamiento** y, a continuación, en la lista de resultados, seleccione **Cuentas de almacenamiento**.

1. En la hoja  **Cuentas de almacenamiento** , seleccione **+ Crear**.

1. En la hoja **Crear una cuenta de almacenamiento**, en la pestaña **Aspectos básicos**, realice las siguientes acciones y seleccione **Revisar**:

   | Configuración | Acción |
   | -- | -- |
   | Lista desplegable de **Suscripción** | Conserve los valores predeterminados |
   | Sección **Grupo de recursos** | Seleccione **Crear nuevo**, escriba **ConfidentialStack** y seleccione **Aceptar** |
   | Cuadro de texto **Nombre de la cuenta de almacenamiento**  | Escriba **securestor** _[sunombre]_ |
   | Lista desplegable de **región** | Seleccione **(EE.UU.) Este de EE. UU.** |
   | Sección **Rendimiento** | Seleccione la opción **Estándar** |
   | Lista desplegable de **Redundancia** | Seleccione **Almacenamiento con redundancia local (LRS)**. |

   En la captura de pantalla siguiente, se muestran los valores configurados en la hoja **Crear una cuenta de almacenamiento**.

   ![Captura de pantalla en la que se muestran los valores configurados en la hoja Crear una cuenta de almacenamiento](./media/l07_create_a_storage_account.png)

1. En la pestaña **Revisar**, revise las opciones que seleccionó en los pasos anteriores.

1. Seleccione **Crear** para crear la cuenta de almacenamiento mediante la configuración especificada.

    > **Nota**: Espere a que se complete la tarea de creación antes de continuar con este laboratorio.

1. En la hoja **Información general sobre la implementación**, seleccione **Ir al recurso**.

1. En la hoja **Cuenta de almacenamiento** , en la sección **Seguridad y redes** , seleccione el vínculo **Claves de acceso** .

1. En la sección **Claves de acceso** , seleccione **Mostrar claves**.

1. Seleccione alguna de las claves y registre el valor en cualquiera de los cuadros  **Cadena de conexión** . Usará este valor más adelante en este laboratorio.

    > **Nota**: No importa la cadena de conexión que elija. Son intercambiables.

#### Tarea 3: Creación de una instancia de Azure Key Vault

1. En Azure Portal, use el cuadro de texto **Buscar recursos, servicios y documentos** para buscar **Almacenes de claves** y, a continuación, en la lista de resultados, seleccione **Almacenes de claves**.

1. En la hoja **Almacenes de claves**, seleccione **Crear**.

1. En la hoja **Crear almacén de claves**, en la pestaña **Aspectos básicos**, realice las siguientes acciones y seleccione **Revisar y crear**:

   | Configuración | Acción |
   | -- | -- |
   | Lista desplegable de **Suscripción** | Conserve los valores predeterminados |
   | Lista desplegable del **grupo de recursos** | Seleccionar **ConfidentialStack** en la lista |
   | Cuadro de texto **Nombre del almacén de claves**  | Escribir **securevault** _[sunombre]_ |
   | Lista desplegable de **Región** | Seleccione **Este de EE. UU**. |
   | Lista desplegable de **planes de tarifa** | Seleccione **Estándar**. |

   En la captura de pantalla siguiente, se muestran los valores configurados en la hoja **Crear almacén de claves**.

   ![Captura de pantalla en la que se muestran los valores configurados en la hoja Crear almacén de claves](./media/l07_create_key_vault.png)

1. En la pestaña **Revisar y crear**, revise las opciones que seleccionó durante los pasos anteriores.

1. Seleccione **Crear** para crear el almacén de claves mediante la configuración especificada.

    > **Nota**: Espere a que se complete la tarea de creación antes de continuar con este laboratorio.

#### Tarea 4: Creación de una aplicación de funciones

1. En Azure Portal, use el cuadro de texto **Buscar recursos, servicios y documentos** para buscar la **Aplicación de funciones** y, a continuación, en la lista de resultados, seleccione **Aplicación de funciones**.

1. En la hoja **Aplicación de funciones**, seleccione **Crear**.

1. En la hoja **Crear aplicación de funciones**, en la pestaña **Aspectos básicos**, realice las siguientes acciones y, a continuación, seleccione **Siguiente: Hosting**:

    | Configuración | Acción |
    | -- | -- |
    | Lista desplegable de **Suscripción** | Conserve los valores predeterminados |
    | Lista desplegable del **grupo de recursos** | Seleccione **ConfidentialStack** |
    | Cuadro de texto **Nombre de la aplicación de funciones**  | Escriba **securefunc** _[sunombre]_ |
    | Sección **Publicar** | Seleccione **Código**. |
    | Lista desplegable de la **pila en tiempo de ejecución** | Seleccione **.NET** |
    | Lista desplegable de **Versión** | Seleccionar **6** |
    | Lista desplegable de **Región** | Seleccionar la región **Este de EE. UU.** |
    | Sección del **sistema operativo** | Seleccione **Linux**. |
    | Lista desplegable del **Tipo de plan** | Seleccione **Consumo (sin servidor)** |

    En la captura de pantalla siguiente, se muestran los valores configurados en la hoja **Crear aplicación de funciones**.

    ![Captura de pantalla en la que se muestran los valores configurados en la hoja Crear aplicación de funciones](./media/l07_create_function_app.png)

1. En la pestaña **Almacenamiento**, realice las siguientes acciones y, a continuación, seleccione **Revisar y crear**:

    | Configuración | Acción |
    | -- | -- |
    | Lista desplegable de **cuenta de almacenamiento** | Seleccione la cuenta de almacenamiento **securestor** _[sunombre]_ |

1. En la pestaña **Revisar y crear**, revise las opciones que seleccionó durante los pasos anteriores.

1. Seleccione **Crear** para crear la aplicación de funciones mediante la configuración especificada.

    > **Nota**: Espere a que se complete la tarea de creación antes de continuar con este laboratorio.

#### Revisar

En este ejercicio, ha creado todos los recursos que usará en este laboratorio.

### Ejercicio 2: Configuración de secretos e identidades

#### Tarea 1: Configuración de una identidad de servicio administrada asignada por el sistema

1. En el panel de navegación de Azure Portal, seleccione el vínculo **Grupos de recursos**.

1. En la hoja **Grupos de recursos**, seleccione el grupo de recursos **ConfidentialStack**.

1. En la hoja **ConfidentialStack**, seleccione la aplicación de funciones **securefunc** _[yourname]_.

    > **Nota**: Habrá dos recursos, una aplicación de funciones y un recurso de Application Insights, con el mismo nombre. Asegúrese de seleccionar el recurso de la aplicación de funciones.

1. En la hoja **Aplicación de funciones**, seleccione la opción **Identidad** en la sección **Configuración**.

1. En el panel **Identidad**, en la pestaña **Asignado por el sistema**, establezca **Estado** en **Activado** y, a continuación, seleccione **Guardar**.

1. Seleccione **Sí** para confirmar la configuración.

    > **Nota**: Espere a que se cree la identidad administrada asignada por el sistema antes de avanzar con este laboratorio.

#### Tarea 2: Creación de un secreto de almacén de claves

1. En el **panel de navegación** de Azure Portal, seleccione el vínculo **Grupos de recursos**.

1. En la hoja **Grupos de recursos**, seleccione el grupo de recursos **ConfidentialStack**.

1. En la hoja **ConfidentialStack**, seleccione el almacén de claves **securevault** _[yourname]_.

1. En la hoja **Key Vault**, seleccione el vínculo **Secretos** en la sección **Objetos**.

1. En el panel **Secretos**, seleccione **+ Generar o importar**.

1. En la hoja **Crear un secreto**, realice las siguientes acciones y, a continuación, seleccione **Crear**:

    | Configuración | Acción |
    | -- | -- |
    | Lista desplegable de **opciones de carga** | Seleccione **Manual**. |
    | Cuadro de texto de **nombre** | Escriba **storagecredentials** |
    | Cuadro de texto **Valor** | Escriba la cadena de conexión de la cuenta de almacenamiento que registró anteriormente en este laboratorio. |
    | Cuadro de texto **Tipo de contenido** | Déjelo en blanco. |
    | Casilla **Establecer fecha de activación** | No seleccionado |
    | Casilla **Establecer fecha de expiración** | No seleccionado |
    | Opción **Activado** | Seleccione **Sí**. |

    En la captura de pantalla siguiente, se muestran los valores configurados en la hoja **Crear un secreto**.

    ![Captura de pantalla en la que se muestran los valores configurados en la hoja Crear un secreto ](./media/l07_create_a_secret.png)

    > **Nota**: Espere a que se cree el secreto antes de continuar con este laboratorio.

1. Vuelva al panel **Secretos** y seleccione el elemento **storagecredentials** de la lista.

1. En el panel **Versiones**, seleccione la versión más reciente del secreto **storagecredentials**.

1. En el panel **Versión del secreto**, realice las siguientes acciones:

    1. Seleccione **Mostrar valor del secreto** para ver el valor asignado al secreto.

    1. Registre el valor del cuadro de texto **Identificador secreto** porque lo usará más adelante en el laboratorio.

    > **Nota**: Está registrando el valor del cuadro de texto **Identificador secreto,** no el cuadro de texto **Valor del secreto**.

#### Tarea 3: Configuración de una directiva de acceso de Key Vault

1. En el panel de navegación de Azure Portal, seleccione el vínculo **Grupos de recursos**.

1. En la hoja **Grupos de recursos**, seleccione el grupo de recursos **ConfidentialStack**.

1. En la hoja **ConfidentialStack**, seleccione el almacén de claves **securevault[yourname]**.

1. En la hoja **Key Vault**, seleccione el vínculo **Directivas de acceso** en la sección **Introducción**.

1. En el panel **Directivas de acceso**, seleccione **+ Crear**.

1. En la hoja **Crear una directiva de acceso**, seleccione la sección **1 Permisos** y realice las siguientes selecciones:

    | Configuración | Acción |
    | -- | -- |
    | Lista desplegable **Configurar a partir de una plantilla** | Déjelo en blanco. |
    | Casillas **Permisos de clave** | 0 servicios seleccionados |
    | Casillas **Permisos secretos** | Seleccione el permiso **Obtener** |
    | Casillas **Permisos de certificado** | 0 servicios seleccionados |

1. Seleccione la sección **2 Entidad** de Seguridad y realice las siguientes selecciones: 

    | Configuración | Acción |
    | -- | -- |
    | Vínculo **Seleccionar entidad de seguridad** | Busque y, a continuación, seleccione la entidad de servicio denominada **securefunc** _[yourname]_. La identidad administrada asignada por el sistema que creó anteriormente en este laboratorio tendrá el mismo nombre que el recurso de Azure Functions. |

1. Seleccione **4 Revisar y crear** y después **Crear**.

    > **Nota**: Espere a que se guarden los cambios en las directivas de acceso antes de continuar con este laboratorio.

#### Tarea 4: Creación de una configuración de la aplicación derivada de Key Vault

1. En el panel de navegación de Azure Portal, seleccione el vínculo **Grupos de recursos**.

1. En la hoja **Grupos de recursos**, seleccione el grupo de recursos **ConfidentialStack**.

1. En la hoja **ConfidentialStack**, seleccione la aplicación de funciones **securefunc[yourname]** .

1. En la hoja **Aplicación de funciones**, seleccione la opción **Configuración** en la sección **Configuración**.

1. En el panel **Configuración**, en la pestaña **Configuración de la aplicación**, seleccione **Nueva configuración de la aplicación**.

1. En la ventana emergente **Agregar o editar configuración de la aplicación**, en el cuadro de texto **Nombre**, escriba **StorageConnectionString**.

1. En el cuadro de texto **Valor**, construya un valor mediante la sintaxis `@Microsoft.KeyVault(SecretUri=<Secret Identifier>)`, donde el marcador de posición `<Secret Identifier>` representa el identificador secreto que registró anteriormente en este ejercicio.

    > **Nota**: Por ejemplo, si el identificador secreto es `https://securevaultstudent.vault.azure.net/secrets/storagecredentials/17b41386df3e4191b92f089f5efb4cbf`, el valor resultante sería `@Microsoft.KeyVault(SecretUri=https://securevaultstudent.vault.azure.net/secrets/storagecredentials/17b41386df3e4191b92f089f5efb4cbf)`.

1. Deje la casilla **configuración de la ranura de implementación** establecida en su valor predeterminado (no seleccionado) y, a continuación, seleccione **Aceptar** para cerrar la ventana emergente y volver a la sección **Configuración**.

1. Seleccione **Guardar** para guardar la configuración y, a continuación, en el cuadro de diálogo emergente **Guardar cambios**, seleccione **Continuar**.

    > **Nota**: Espere a que se guarde la configuración de la aplicación antes de continuar con el laboratorio.

#### Revisar

En este ejercicio, ha creado una identidad de servicio administrada asignada por el sistema para la aplicación de funciones y, a continuación, ha concedido a esa identidad los permisos adecuados para obtener el valor de un secreto en el almacén de claves. Por último, ha creado un secreto al que ha hecho referencia dentro de las opciones de configuración de la aplicación de funciones.

### Ejercicio 3: Compilación de una aplicación de Azure Functions

#### Tarea 1: Inicialización de un proyecto de función

1. En la barra de tareas, seleccione el icono **Terminal Windows**.

1. Ejecute el siguiente comando para cambiar el directorio actual al directorio vacío **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

    ```powershell
    cd F:\Allfiles\Labs\07\Starter\func
    ```

    > **Nota**: En el Explorador de Windows, quite el atributo de solo lectura del archivo F:\Allfiles\Labs\07\Starter\func\.gitignore.

1. Ejecute el siguiente comando para usar **Azure Functions Core Tools** para crear un nuevo proyecto de Functions local en el directorio actual mediante el entorno de ejecución **dotnet**:

    ```powershell
    func init --worker-runtime dotnet --force
    ```

    > **Nota**: Puede revisar la documentación para [crear un proyecto][azure-functions-core-tools-new-project] mediante **Azure Functions Core Tools**.

1. Ejecute el comando siguiente para **compilar** el proyecto de .NET 6:

    ```powershell
    dotnet build
    ```

#### Tarea 2: Creación de una función desencadenada por HTTP

1. Ejecute el siguiente comando para usar **Azure Functions Core Tools** para crear una nueva función denominada **FileParser** mediante la plantilla de **desencadenador HTTP**:

    ```powershell
    func new --template "HTTP trigger" --name "FileParser"
    ```

    > **Nota**: Puede revisar la documentación para [crear una nueva función][azure-functions-core-tools-new-function] mediante **Azure Functions Core Tools**.

1. Cierre la aplicación que ejecuta **Terminal Windows** actualmente.

#### Tarea 3: Configuración y lectura de una configuración de la aplicación

1. En la pantalla **Inicio**, seleccione el icono **Visual Studio Code**.

1. En el menú **Archivo**, seleccione **Abrir carpeta**.

1. En la ventana **Explorador de archivos** que se abre, vaya a **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func** y, a continuación, seleccione **Seleccionar carpeta**.

1. En el panel **Explorador** de la ventana **Visual Studio Code**, abra el archivo **local.settings.json**.

1. Anote el valor actual del objeto **Valores**:

    ```json
    "Values": {
        "AzureWebJobsStorage": "UseDevelopmentStorage=true",
        "FUNCTIONS_WORKER_RUNTIME": "dotnet"
    }
    ```

1. Actualice el valor del objeto **Values** agregando una nueva configuración denominada **StorageConnectionString** y, a continuación, asignándole un valor de cadena de **[TEST VALUE]** :

    ```json
    "Values": {
        "AzureWebJobsStorage": "UseDevelopmentStorage=true",
        "FUNCTIONS_WORKER_RUNTIME": "dotnet",
        "StorageConnectionString": "[TEST VALUE]"
    }
    ```

1. Ahora el archivo **local.settings.json** debe incluir:

    ```json
    {
        "IsEncrypted": false,
        "Values": {
            "AzureWebJobsStorage": "UseDevelopmentStorage=true",
            "FUNCTIONS_WORKER_RUNTIME": "dotnet",
            "StorageConnectionString": "[TEST VALUE]"
        }
    }
    ```

1. Seleccione **Guardar** para guardar los cambios en el archivo **local.settings.json**.

1. En el panel **Explorador** de la ventana **Visual Studio Code**, abra el archivo **FileParser.cs**.

1. En el editor de código, elimine todo el contenido.

1. Agregue el siguiente código en el archivo **FileParser.cs**:

    ```csharp
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using System;
    using System.Threading.Tasks;
    public static class FileParser
    {
         /* Append an attribute to the Run method of type FunctionNameAttribute
            that has its name parameter set to a value of FileParser */ 
        [FunctionName("FileParser")]
        public static async Task<IActionResult> Run(
             /* Append an attribute to the request parameter of type  HttpTriggerAttribute
             that has its methods parameter array set to a single value of GET */
            [HttpTrigger("GET")] HttpRequest request)
        {
             /* Retrieve the value of the StorageConnectionString application setting by
                using the Environment.GetEnvironmentVariable method and to store the result
                in a string variable named connectionString */
            string connectionString = Environment.GetEnvironmentVariable("StorageConnectionString");

             /* Return the value of the connectionString variable as the HTTP response */
            return new OkObjectResult(connectionString);
        }
    }
    ```

1. Seleccione **Guardar** para guardar los cambios en el archivo **FileParser.cs**.

#### Tarea 4: Validación de la función local

1. En la barra de tareas, seleccione el icono **Terminal Windows**.

1. Ejecute el siguiente comando para cambiar el directorio actual al directorio vacío **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

    ```powershell
    cd F:\Allfiles\Labs\07\Starter\func
    ```

1. Ejecute el siguiente comando para ejecutar el proyecto de la aplicación de funciones:

    ```powershell
    func start --build
    ```

    > **Nota**: Puede revisar la documentación para [iniciar el proyecto de la aplicación de funciones localmente][azure-functions-core-tools-start-function] mediante **Azure Functions Core Tools**.

1. En la barra de tareas, vuelva a seleccionar el icono **Terminal Windows** para abrir una nueva instancia de la aplicación **Terminal Windows**. Ejecute el siguiente comando para cambiar el directorio actual al directorio vacío **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

    ```powershell
    cd F:\Allfiles\Labs\07\Starter\func
    ```
    
1. Cuando reciba el símbolo del sistema abierto, ejecute el siguiente comando para iniciar la herramienta **httprepl**, estableciendo el identificador uniforme de recursos (URI) base en ``http://localhost:7071``:

    ```powershell
    httprepl http://localhost:7071
    ```

    > **Nota**: La herramienta **httprepl** muestra un mensaje de error. Este mensaje se produce porque la herramienta está buscando un archivo de definición de Swagger que se usará para atravesar la API. Dado que el proyecto de la función no genera un archivo de definición de Swagger, deberá recorrer la API manualmente.
1. Cuando reciba el símbolo del sistema de la herramienta, ejecute el siguiente comando para ir al directorio de **api** relativo:

    ```powershell
    cd api
    ```

1. Ejecute el siguiente comando para ir al directorio **fileparser** relativo:

    ```powershell
    cd fileparser
    ```

1. Ejecute el comando siguiente para ejecutar el comando **get**:

    ```powershell
    get
    ```

1. Observe el valor **[TEST VALUE]** de **StorageConnectionString** que se devuelve como resultado de la solicitud HTTP:

    ```powershell
    HTTP/1.1 200 OK
    Content-Type: text/plain; charset=utf-8
    Date: Tue, 01 Sep 2020 23:35:39 GMT
    Server: Kestrel
    Transfer-Encoding: chunked
    [TEST VALUE]
    ```

1. Ejecute el comando siguiente para salir de la herramienta **httprepl**:

    ```powershell
    exit
    ```

1. Cierre todas las instancias actualmente en ejecución de la aplicación **Terminal Windows**.

#### Tarea 5: Implementación de la función mediante Azure Functions Core Tools

1. En la barra de tareas, seleccione el icono **Terminal Windows**.

1. Ejecute el siguiente comando para cambiar el directorio actual al directorio vacío **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

    ```powershell
    cd F:\Allfiles\Labs\07\Starter\func
    ```

1. Ejecute el siguiente comando para iniciar sesión en la interfaz de la línea de comandos (CLI) de Azure:

    ```powershell
    az login
    ```

1. En la ventana del explorador **Microsoft Edge**, escriba la dirección de correo electrónico y la contraseña de su cuenta Microsoft y, a continuación, seleccione **Iniciar sesión**.

1. Vuelva a la ventana de **Terminal Windows** abierta actualmente. Espere a que finalice el proceso de inicio de sesión.

1. Ejecute el comando siguiente para publicar el proyecto de aplicación de funciones (reemplace el marcador de posición `<function-app-name>` por el nombre de la aplicación de funciones que creó anteriormente en este laboratorio):

    ```powershell
    func azure functionapp publish <function-app-name>
    ```

    > **Nota**: Por ejemplo, si el **nombre de la aplicación de funciones** es **securefuncstudent**, el comando sería ``func azure functionapp publish securefuncstudent``. Puede revisar la documentación para [publicar el proyecto de la aplicación de funciones local][azure-functions-core-tools-publish-azure] mediante **Azure Functions Core Tools**.

1. Espere a que la implementación se finalice antes de avanzar con el laboratorio.

1. Cierre la aplicación que ejecuta **Terminal Windows** actualmente.

#### Tarea 6: Configuración de la aplicación derivada de Key Vault

1. En la barra de tareas, seleccione el icono **Microsoft Edge** y, a continuación, seleccione la pestaña que contiene Azure Portal.

1. En el panel de navegación de Azure Portal, seleccione el vínculo **Grupos de recursos**.

1. En la hoja **Grupos de recursos**, seleccione el grupo de recursos **ConfidentialStack**.

1. En la hoja **ConfidentialStack**, seleccione la aplicación de funciones **securefunc[yourname]** .

1. En la hoja de **Aplicación de funciones**, en la sección **Funciones**, seleccione la opción **Funciones**.

1. En el panel **Funciones**, seleccione la función **FileParser** existente.

1. En la hoja **Función**, seleccione la opción **Código y prueba** en la sección **Desarrollador**.

1. En el editor de funciones, seleccione **Probar o ejecutar**.

1. En el panel que se muestra de forma automática, en la lista **Método HTTP**, seleccione **GET**.

1. Seleccione **Ejecutar** para probar la función.

1. Revise los resultados de la serie de pruebas. El resultado debe ser la cadena de conexión de Azure Storage.

#### Revisar

En este ejercicio, ha usado una identidad de servicio para leer el valor de un secreto almacenado en Key Vault y ha devuelto ese valor como resultado de una aplicación de funciones.

### Ejercicio 4: Acceso a datos de Azure Blob Storage

#### Tarea 1: Carga de un blob de almacenamiento de ejemplo

1. En el panel de navegación de Azure Portal, seleccione el vínculo **Grupos de recursos**.

1. En la hoja **Grupos de recursos**, seleccione el grupo de recursos **ConfidentialStack**.

1. En la hoja **ConfidentialStack**, seleccione la cuenta de almacenamiento **securestor** _[yourname]_.

1. En la hoja **Cuenta de almacenamiento**, en la sección **Almacenamiento de datos**, seleccione el vínculo **Contenedores**.

1. En la sección **Contenedores**, seleccione **+ Contenedor**.

1. En la ventana emergente **Nuevo contenedor**, realice las siguientes acciones y, a continuación, seleccione **Crear**:

    | Configuración | Acción |
    | -- | -- |
    | Cuadro de texto de **nombre** | Escriba **drop** |
    | Lista desplegable del **nivel de acceso público** | Seleccionar **Blob (acceso de lectura anónimo solo para blobs)** |

1. Vuelva a la sección **Contenedores** y, a continuación, seleccione el contenedor **drop** recién creado.

1. En la hoja **Contenedor**, seleccione **Cargar**.

1. En la ventana **Cargar blob**, realice las siguientes acciones y, a continuación, seleccione **Cargar**:

    | Configuración | Acción |
    | -- | -- |
    | Sección **Archivos** | Seleccione **Buscar archivos** o use la característica de arrastrar y colocar. |
    | Ventana **Explorador de archivos**  | Vaya a **Allfiles (F):\\Allfiles\\Labs\\07\\Starter**, seleccione el archivo **records.json** y, a continuación, seleccione **Abrir**. |
    | Casilla **Sobrescribir si ya hay archivos** | Asegurarse de que esta casilla está seleccionada |

    > **Nota**: Espere a que se cargue el blob antes de continuar con este laboratorio.

1. Vuelva a la hoja **Contenedor** y seleccione el blob **records.json** en la lista de blobs.

1. En la hoja **Blob**, busque los metadatos del blob y copie la dirección URL del blob.

1. En la barra de tareas, active el menú contextual del icono **Microsoft Edge** y, a continuación, seleccione **Nueva ventana**.

1. En la nueva ventana del explorador, consulte la dirección URL que copió para el blob.

1. Ahora debería mostrarse el contenido de la notación de objetos JavaScript (JSON) del blob. Cierre la ventana del explorador con el contenido del JSON.

1. Vuelva a la ventana del explorador con Azure Portal y, a continuación, cierre la hoja **Blob**.

1. Vuelva a la hoja **Contenedor** y seleccione **Cambiar nivel de acceso**.

1. En la ventana emergente **Cambiar nivel de acceso**, realice las siguientes acciones:

    1. En la lista desplegable **Nivel de acceso público**, seleccione **Privado (sin acceso anónimo)**.
    1. Seleccione **Aceptar**.

1. En la barra de tareas, active el menú contextual del icono **Microsoft Edge** y, a continuación, seleccione **Nueva ventana**.

1. En la nueva ventana del explorador, consulte la dirección URL que copió para el blob.

1. Ahora debería mostrarse un mensaje de error que indica que no se encontró el recurso.

    > **Nota**: Si no se muestra el mensaje de error, es posible que el explorador haya almacenado en caché el archivo. Seleccione CTRL+F5 para actualizar la página hasta que se muestre el mensaje de error.

#### Tarea 2: Extracción y configuración del SDK de Azure para .NET

1. En la barra de tareas, seleccione el icono **Terminal Windows**.

1. Ejecute el siguiente comando para cambiar el directorio actual al directorio vacío **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

    ```powershell
    cd F:\Allfiles\Labs\07\Starter\func
    ```

1. Ejecute el comando siguiente para agregar la versión **12.12.0** del paquete **Azure.Storage.Blobs** de NuGet:

    ```powershell
    dotnet add package Azure.Storage.Blobs --version 12.12.0
    ```

    > **Nota**: el paquete de NuGet [Azure.Storage.Blobs](https://www.nuget.org/packages/Azure.Storage.Blobs) hace referencia al subconjunto del SDK de Azure para .NET necesario para escribir código para Azure Blob Storage.

1. Cierre la aplicación que ejecuta **Terminal Windows** actualmente.

1. En la pantalla **Inicio**, seleccione el icono **Visual Studio Code**.

1. En el menú **Archivo**, seleccione **Abrir carpeta**.

1. En la ventana **Explorador de archivos** que se abre, vaya a **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func** y, a continuación, seleccione **Seleccionar carpeta**.

1. En el panel **Explorador** de la ventana **Visual Studio Code**, abra el archivo **FileParser.cs**.

1. Agregue una **directiva using** para el espacio de nombres **Azure.Storage.Blobs**:

    ```csharp
    using Azure.Storage.Blobs;
    ```

1. Revise el contenido del archivo **FileParser.cs**, que ahora debe incluir:

    ```csharp
    using Azure.Storage.Blobs;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using System;
    using System.Threading.Tasks;   
    public static class FileParser
    {
        [FunctionName("FileParser")]
        public static async Task<IActionResult> Run(
            [HttpTrigger("GET")] HttpRequest request)
        {
            string connectionString = Environment.GetEnvironmentVariable("StorageConnectionString");
            return new OkObjectResult(connectionString);
        }
    }
    ```

#### Tarea 3: Escritura de código de Azure Blob Storage mediante el SDK de Azure para .NET

1. Actualice el contenido del archivo **FileParser.cs** con el código siguiente:

    ```csharp
    using Azure.Storage.Blobs;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using System;
    using System.Threading.Tasks;
    public static class FileParser
    {
        [FunctionName("FileParser")]
        public static async Task<IActionResult> Run(
            [HttpTrigger("GET")] HttpRequest request)
        {
            string connectionString = Environment.GetEnvironmentVariable("StorageConnectionString");
            /* Create a new instance of the BlobClient class by passing in your 
               connectionString variable, a  "drop" string value, and a 
               "records.json" string value to the constructor */
            BlobClient blob = new BlobClient(connectionString, "drop", "records.json");

            /* Use the BlobClient.DownloadAsync method to download the contents of 
               the referenced blob asynchronously, and then store the result in 
               a variable named "response" */
            var response = await blob.DownloadAsync();

             /* Return the value of the various content stored in the content 
                variable by using the FileStreamResult class constructor */
            return new FileStreamResult(response?.Value?.Content, response?.Value?.ContentType);
        }
    }
    ```

1. Seleccione **Guardar** para guardar los cambios en el archivo **FileParser.cs**.

#### Tarea 4: Implementación y validación de la aplicación de Azure Functions

1. En la barra de tareas, seleccione el icono **Terminal Windows**.

1. Ejecute el siguiente comando para cambiar el directorio actual al directorio vacío **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

    ```powershell
    cd F:\Allfiles\Labs\07\Starter\func
    ```

1. Ejecute el siguiente comando para iniciar sesión en la CLI de Azure:

    ```powershell
    az login
    ```

1. En la ventana del explorador **Microsoft Edge**, escriba la dirección de correo electrónico y la contraseña de su cuenta Microsoft y, a continuación, seleccione **Iniciar sesión**.

1. Vuelva a la ventana de **Terminal Windows** abierta actualmente. Espere a que finalice el proceso de inicio de sesión.

1. Ejecute el comando siguiente para publicar el proyecto de aplicación de funciones (reemplace el marcador de posición `<function-app-name>` por el nombre de la aplicación de funciones que usó anteriormente en este laboratorio):

    ```powershell
    func azure functionapp publish <function-app-name>
    ```

    > **Nota**: Por ejemplo, si el **nombre de la aplicación de funciones** es **securefuncstudent**, el comando sería ``func azure functionapp publish securefuncstudent``. Puede revisar la documentación para [publicar el proyecto de la aplicación de funciones local][azure-functions-core-tools-publish-azure] mediante **Azure Functions Core Tools**.

1. Espere a que la implementación se finalice antes de avanzar con el laboratorio.

1. Cierre la aplicación que ejecuta **Terminal Windows** actualmente.

1. En la barra de tareas, seleccione el icono **Microsoft Edge** y, a continuación, vaya a Azure Portal.

1. En el panel de navegación de Azure Portal, seleccione el vínculo **Grupos de recursos**.

1. En la hoja **Grupos de recursos**, seleccione el grupo de recursos **ConfidentialStack**.

1. En la hoja **ConfidentialStack**, seleccione la aplicación de funciones **securefunc[yourname]** .

1. En la hoja de **Aplicación de funciones**, en la sección **Funciones**, seleccione la opción **Funciones**.

1. En el panel **Funciones**, seleccione la función **FileParser** existente.

1. En la hoja **Función**, seleccione la opción **Código y prueba** en la sección **Desarrollador**.

1. En el editor de funciones, seleccione **Probar o ejecutar**.

1. En el panel que se muestra de forma automática, en la lista **Método HTTP**, seleccione **GET**.

1. Seleccione **Ejecutar** para probar la función.

1. Revise los resultados de la serie de pruebas. La salida contendrá el contenido del blob **$/drop/records.json** almacenado en la cuenta de Azure Storage.

#### Revisar

En este ejercicio, ha usado código C\# para acceder a una cuenta de almacenamiento y, a continuación, ha descargado el contenido de un blob.
